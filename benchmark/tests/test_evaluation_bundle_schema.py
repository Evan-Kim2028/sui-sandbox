"""Schema validation tests for A2A EvaluationBundle.

These tests ensure that the evaluation_bundle artifact generated by the Green Agent
matches the specification documented in docs/A2A_EXCHANGES.md.
"""

from __future__ import annotations

from typing import Any


def validate_evaluation_bundle(bundle: dict[str, Any]) -> None:
    """Validate an evaluation bundle against the spec.

    Raises ValueError with descriptive message if validation fails.
    """
    # Top-level required fields
    required_top_level = [
        "schema_version",
        "spec_url",
        "benchmark",
        "run_id",
        "exit_code",
        "timings",
        "config",
        "metrics",
        "artifacts",
    ]
    for field in required_top_level:
        if field not in bundle:
            raise ValueError(f"Missing required top-level field: {field}")

    # Validate types and values
    if bundle["schema_version"] != 1:
        raise ValueError(f"Unsupported schema_version: {bundle['schema_version']}")

    if bundle["spec_url"] != "smi-bench:evaluation_bundle:v1":
        raise ValueError(f"Invalid spec_url: {bundle['spec_url']}")

    # Timings
    timings = bundle["timings"]
    if not isinstance(timings, dict):
        raise ValueError("timings must be a dictionary")
    for field in ["started_at_unix_seconds", "finished_at_unix_seconds", "elapsed_seconds"]:
        if field not in timings:
            raise ValueError(f"Missing required timing field: {field}")

    # Metrics
    metrics = bundle["metrics"]
    if not isinstance(metrics, dict):
        raise ValueError("metrics must be a dictionary")
    # Recommended metrics based on docs
    for field in ["avg_hit_rate", "packages_total", "packages_with_error", "packages_timed_out"]:
        if field not in metrics:
            # We don't strictly enforce these yet as they might be missing in partial runs,
            # but they should ideally be present.
            pass

    # Artifacts
    artifacts = bundle["artifacts"]
    if not isinstance(artifacts, dict):
        raise ValueError("artifacts must be a dictionary")
    for field in ["results_path", "run_metadata_path", "events_path"]:
        if field not in artifacts:
            raise ValueError(f"Missing required artifact field: {field}")


def test_valid_bundle_passes_validation() -> None:
    """Test that a correctly formatted bundle passes validation."""
    valid_bundle = {
        "schema_version": 1,
        "spec_url": "smi-bench:evaluation_bundle:v1",
        "benchmark": "phase2_inhabit",
        "run_id": "test_run_123",
        "exit_code": 0,
        "timings": {
            "started_at_unix_seconds": 1000,
            "finished_at_unix_seconds": 1100,
            "elapsed_seconds": 100.0,
        },
        "config": {
            "corpus_root": "/tmp/corpus",
            "package_ids_file": "manifest.txt",
            "samples": 1,
            "rpc_url": "http://localhost:9000",
            "simulation_mode": "dry-run",
        },
        "metrics": {
            "avg_hit_rate": 0.5,
            "packages_total": 1,
            "packages_with_error": 0,
            "packages_timed_out": 0,
        },
        "artifacts": {
            "results_path": "results/test.json",
            "run_metadata_path": "logs/test/run_metadata.json",
            "events_path": "logs/test/events.jsonl",
        },
    }
    validate_evaluation_bundle(valid_bundle)


def test_missing_field_fails_validation() -> None:
    """Test that missing required fields trigger validation errors."""
    invalid_bundle = {
        "schema_version": 1,
        # Missing spec_url
        "benchmark": "phase2_inhabit",
    }
    try:
        validate_evaluation_bundle(invalid_bundle)
        assert False, "Should have raised ValueError"
    except ValueError as e:
        assert "Missing required top-level field: spec_url" in str(e)


def test_invalid_version_fails_validation() -> None:
    """Test that incorrect schema versions trigger validation errors."""
    invalid_bundle = {
        "schema_version": 2,  # Wrong version
        "spec_url": "smi-bench:evaluation_bundle:v1",
        "benchmark": "phase2_inhabit",
        "run_id": "test",
        "exit_code": 0,
        "timings": {},
        "config": {},
        "metrics": {},
        "artifacts": {},
    }
    try:
        validate_evaluation_bundle(invalid_bundle)
        assert False, "Should have raised ValueError"
    except ValueError as e:
        assert "Unsupported schema_version: 2" in str(e)
