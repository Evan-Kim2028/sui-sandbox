# Docker Compose for smi-bench local development and testing
# Provides idempotent container lifecycle with proper cleanup
#
# Usage:
#   docker compose up -d --wait    # Start and wait for healthy
#   docker compose down --timeout 10  # Graceful shutdown
#   docker compose logs -f         # Stream logs
#
# For CI:
#   docker compose up -d --wait --wait-timeout 60
#   docker compose exec -T smi-bench smi-inhabit --corpus-root /app/corpus ...
#   docker compose down --timeout 10

services:
  smi-bench:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smi-bench-dev
    # Run as non-root user (matches Dockerfile USER directive)
    user: "1000:1000"
    ports:
      - "9999:9999"
    volumes:
      # Mount the full sui-packages directory to resolve symlinks
      - ../sui-packages/packages:/corpus:ro
      # Results and logs are writable
      - ./results:/app/results
      - ./logs:/app/logs
    environment:
      - SMI_MODEL=${SMI_MODEL:-google/gemini-3-flash-preview}
      - SMI_AGENT=${SMI_AGENT:-real-openai-compatible}
      - SMI_RPC_URL=${SMI_RPC_URL:-https://fullnode.mainnet.sui.io:443}
    env_file:
      - path: benchmark/.env
        required: false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Allow 30s for graceful shutdown of long-running tasks
    stop_grace_period: 30s
    # Use tini as init (redundant with Dockerfile but explicit)
    init: true
    restart: "no"

  # Optional: Purple agent for full A2A scenario testing
  smi-bench-purple:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smi-bench-purple-dev
    user: "1000:1000"
    ports:
      - "9998:9998"
    command: ["smi-a2a-purple", "--port", "9998"]
    environment:
      - SMI_MODEL=${SMI_MODEL:-google/gemini-3-flash-preview}
    env_file:
      - path: benchmark/.env
        required: false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9998/.well-known/agent-card.json"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    stop_grace_period: 10s
    init: true
    restart: "no"
    profiles:
      - full  # Only start with: docker compose --profile full up
